name: Test OSPS Security Assessment Action

on:
  workflow_dispatch:
    inputs:
      target_owner:
        description: 'Target repository owner (organization or user)'
        required: true
        default: 'zohayb23'
      target_repo:
        description: 'Target repository name to assess'
        required: true
        default: 'test-github-action'
      catalog:
        description: 'OSPS catalog to assess against'
        required: false
        default: 'osps-baseline'
      maturity_level:
        description: 'Maturity level to assess'
        required: false
        default: 'Maturity Level 1'
        type: choice
        options:
          - 'Maturity Level 1'
          - 'Maturity Level 2'
          - 'Maturity Level 3'
      log_level:
        description: 'Log level'
        required: false
        default: 'debug'
        type: choice
        options:
          - 'info'
          - 'debug'
          - 'trace'
      output_format:
        description: 'Output format'
        required: false
        default: 'yaml'
        type: choice
        options:
          - 'yaml'
          - 'json'

jobs:
  test-osps-action:
    runs-on: ubuntu-latest
    name: Test OSPS Security Assessment

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout pvtr-github-repo test branch
        uses: actions/checkout@v4
        with:
          repository: zohayb23/pvtr-github-repo
          ref: test/sarif-tool-name-fix
          path: pvtr-github-repo

      - name: Build test Docker image
        working-directory: pvtr-github-repo
        run: |
          echo "ğŸ“¦ Building Docker image with SARIF fix..."
          echo "ğŸ” Checking go.mod replace directive:"
          grep -A 1 "replace.*privateer-sdk" go.mod || echo "âš ï¸ Replace directive not found"
          echo ""
          echo "ğŸ”¨ Building Docker image..."
          docker build -t pvtr-github-repo:test-sarif-fix . || {
            echo "âŒ Docker build failed!"
            echo "ğŸ“‹ go.mod contents:"
            cat go.mod
            exit 1
          }
          echo "âœ… Docker image built successfully"

      - name: Run OSPS Security Assessment (test)
        run: |
          mkdir -p evaluation_results
          chmod 777 evaluation_results
          
          cat > /tmp/pvtr-config.yml << EOF
          loglevel: "info"
          write-directory: evaluation_results
          write: true
          output: "sarif"
          services:
            pvtr:
              plugin: github-repo
              policy:
                catalogs:
                  - "${{ inputs.catalog }}"
                applicability:
                  - "Maturity Level 1"
              vars:
                owner: "${{ inputs.target_owner }}"
                repo: "${{ inputs.target_repo }}"
                token: "${{ secrets.GITHUB_TOKEN }}"
          EOF
          
          docker run --rm \
            -v /tmp/pvtr-config.yml:/.privateer/config.yml \
            -v ${{ github.workspace }}/evaluation_results:/.privateer/bin/evaluation_results \
            pvtr-github-repo:test-sarif-fix

      - name: Prepare SARIF file for upload
        id: sarif
        continue-on-error: true
        run: |
          SARIF_FILE=$(find evaluation_results -name "*.sarif" -type f 2>/dev/null | head -1)
          if [ -n "$SARIF_FILE" ] && [ -f "$SARIF_FILE" ]; then
            # Validate that the SARIF file contains at least one result
            RESULT_COUNT=$(jq '[.runs[]?.results[]?] | length' "$SARIF_FILE" 2>/dev/null || echo "0")
            TOOL_NAME=$(jq -r '.runs[0].tool.driver.name // "empty"' "$SARIF_FILE" 2>/dev/null || echo "empty")
            echo "ğŸ“Š SARIF Analysis:"
            echo "  - Results: $RESULT_COUNT"
            echo "  - Tool Name: $TOOL_NAME"
            if [ "$RESULT_COUNT" -gt 0 ]; then
              echo "âœ… SARIF file contains $RESULT_COUNT result(s)"
              echo "sarif_file=$SARIF_FILE" >> $GITHUB_OUTPUT
              echo "has_results=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸  SARIF file exists but contains no results"
              echo "sarif_file=" >> $GITHUB_OUTPUT
              echo "has_results=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸  No SARIF file found"
            echo "sarif_file=" >> $GITHUB_OUTPUT
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload SARIF to GitHub Security tab
        if: steps.sarif.outputs.sarif_file != '' && steps.sarif.outputs.has_results == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.sarif.outputs.sarif_file }}
          wait-for-processing: true
        continue-on-error: true

      - name: Fix permissions for evaluation_results
        shell: bash
        if: always()
        run: |
          echo "ğŸ”§ Fixing permissions for evaluation_results directory..."
          # Fix ownership and permissions (Docker may create files as root)
          if [ -d "evaluation_results" ]; then
            sudo chown -R runner:runner evaluation_results || sudo chown -R $(id -u):$(id -g) evaluation_results
            sudo chmod -R 775 evaluation_results || chmod -R 775 evaluation_results
            echo "âœ… Permissions fixed"

            # List files to see what was generated by SDK
            echo "ğŸ“ Files in evaluation_results/:"
            find evaluation_results -type f 2>/dev/null || echo "No files found"
          else
            echo "âš ï¸ evaluation_results directory doesn't exist yet"
          fi

      - name: Upload Assessment Results
        uses: actions/upload-artifact@v4
        with:
          name: osps-assessment-results-${{ github.run_number }}
          path: evaluation_results/
          retention-days: 30

      - name: Display Results Summary
        run: |
          echo "âœ… OSPS Security Assessment completed!"
          echo "ğŸ“Š Results saved to: evaluation_results/"
          echo ""
          echo "ğŸ” Checking current directory structure:"
          ls -la
          echo ""
          echo "ğŸ” Checking for evaluation_results directory:"
          if [ -d "evaluation_results" ]; then
            echo "ğŸ“ Files generated:"
            ls -la evaluation_results/
            echo ""
            echo "ğŸ“„ Summary of results:"
            find evaluation_results -name "*.yaml" -o -name "*.json" -o -name "*.sarif" | head -5 | while read file; do
              echo "File: $file"
              if [[ "$file" == *.yaml ]] || [[ "$file" == *.sarif ]]; then
                echo "First few lines:"
                head -10 "$file"
              fi
              echo "---"
            done
          else
            echo "âŒ evaluation_results directory not found!"
            echo "ğŸ” Looking for any files that might contain results:"
            find . -name "*result*" -o -name "*assessment*" -o -name "*.yaml" -o -name "*.json" -o -name "*.sarif" | head -10
          fi
