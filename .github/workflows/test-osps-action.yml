name: Test OSPS Security Assessment Action

on:
  workflow_dispatch:
    inputs:
      target_owner:
        description: 'Target repository owner (organization or user)'
        required: true
        default: 'zohayb23'
      target_repo:
        description: 'Target repository name to assess'
        required: true
        default: 'test-github-action'
      catalog:
        description: 'OSPS catalog to assess against'
        required: false
        default: 'OSPS_B'
      maturity_level:
        description: 'Maturity level to assess'
        required: false
        default: 'Maturity Level 1'
        type: choice
        options:
          - 'Maturity Level 1'
          - 'Maturity Level 2'
          - 'Maturity Level 3'
      log_level:
        description: 'Log level'
        required: false
        default: 'debug'
        type: choice
        options:
          - 'info'
          - 'debug'
          - 'trace'
      output_format:
        description: 'Output format'
        required: false
        default: 'yaml'
        type: choice
        options:
          - 'yaml'
          - 'json'

jobs:
  test-osps-action:
    runs-on: ubuntu-latest
    name: Test OSPS Security Assessment

    permissions:
      contents: read
      packages: read
      security-events: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run OSPS Security Assessment
        uses: zohayb23/pvtr-github-repo-action@main
        with:
          owner: ${{ inputs.target_owner }}
          repo: ${{ inputs.target_repo }}
          token: ${{ secrets.GITHUB_TOKEN }}
          catalog: ${{ inputs.catalog }}
          maturity-level: ${{ inputs.maturity_level }}
          log-level: ${{ inputs.log_level }}
          output-format: ${{ inputs.output_format }}
          upload-sarif: 'true'

      - name: Fix permissions for evaluation_results
        shell: bash
        if: always()
        run: |
          echo "ğŸ”§ Fixing permissions for evaluation_results directory..."
          # Fix ownership and permissions (Docker may create files as root)
          if [ -d "evaluation_results" ]; then
            sudo chown -R runner:runner evaluation_results || sudo chown -R $(id -u):$(id -g) evaluation_results
            sudo chmod -R 775 evaluation_results || chmod -R 775 evaluation_results
            echo "âœ… Permissions fixed"

            # List files to see what was generated by SDK
            echo "ğŸ“ Files in evaluation_results/:"
            find evaluation_results -type f 2>/dev/null || echo "No files found"
          else
            echo "âš ï¸ evaluation_results directory doesn't exist yet"
          fi

      - name: Upload Assessment Results
        uses: actions/upload-artifact@v4
        with:
          name: osps-assessment-results-${{ github.run_number }}
          path: evaluation_results/
          retention-days: 30

      - name: Display Results Summary
        run: |
          echo "âœ… OSPS Security Assessment completed!"
          echo "ğŸ“Š Results saved to: evaluation_results/"
          echo ""
          echo "ğŸ” Checking current directory structure:"
          ls -la
          echo ""
          echo "ğŸ” Checking for evaluation_results directory:"
          if [ -d "evaluation_results" ]; then
            echo "ğŸ“ Files generated:"
            ls -la evaluation_results/
            echo ""
            echo "ğŸ“„ Summary of results:"
            find evaluation_results -name "*.yaml" -o -name "*.json" -o -name "*.sarif" | head -5 | while read file; do
              echo "File: $file"
              if [[ "$file" == *.yaml ]] || [[ "$file" == *.sarif ]]; then
                echo "First few lines:"
                head -10 "$file"
              fi
              echo "---"
            done
          else
            echo "âŒ evaluation_results directory not found!"
            echo "ğŸ” Looking for any files that might contain results:"
            find . -name "*result*" -o -name "*assessment*" -o -name "*.yaml" -o -name "*.json" -o -name "*.sarif" | head -10
          fi
